# Docker Container & Host Metrics — Дашборд Grafana

[Русский] | [English](README.md)

Дашборд Grafana для мониторинга Docker-хостов и контейнеров через Prometheus, cAdvisor и node_exporter.

## Обзор

Этот дашборд предоставляет **единое представление** метрик Docker-хоста и контейнеров, используя Prometheus в качестве источника данных с получением метрик от cAdvisor и node_exporter. Он предлагает комплексное решение для мониторинга Docker-окружений с предварительно настроенными панелями для отслеживания использования ресурсов, метрик производительности и системной информации.

Типичные сценарии использования:
* Домашние лаборатории или небольшие кластеры, где требуется быстрый обзор производительности Docker.
* Продакшн-окружения с Docker-узлами, где нужен готовый мониторинг без сложной настройки.

JSON-файл дашборда из этого репозитория готов к импорту в любой экземпляр Grafana с настроенным источником данных Prometheus.

## Требования

Для использования этого дашборда необходимо:

* **Prometheus**, собирающий метрики с:
  * **cAdvisor** на каждом Docker-хосте (для метрик уровня контейнеров)
  * **node_exporter** на каждом хосте (для метрик уровня узла)
* **Grafana** с настроенным источником данных Prometheus (имя по умолчанию `Prometheus`, или используйте маппинг через `DS_PROMETHEUS` при импорте)

### Пример конфигурации scrape для Prometheus

Добавьте следующие задачи в секцию `scrape_configs` вашего Prometheus:

```yaml
scrape_configs:
  - job_name: 'cadvisor'
    static_configs:
      - targets: ['host1:8080', 'host2:8080']
  
  - job_name: 'node'
    static_configs:
      - targets: ['host1:9100', 'host2:9100']
```

Настройте имена хостов и порты в соответствии с вашим окружением.

## Импорт дашборда

### Импорт через UI Grafana

1. Откройте Grafana и перейдите в раздел **Dashboards** → **Import**.
2. Загрузите JSON-файл из этого репозитория (`10619_rev2.json`).
3. Выберите источник данных Prometheus (или укажите маппинг для `DS_PROMETHEUS`, если потребуется).
4. Нажмите **Import**, чтобы сохранить и открыть дашборд.

Дашборд предполагает, что Prometheus доступен в соответствии с настройками вашего источника данных.

### Импорт через API Grafana

Вы также можете импортировать дашборд программно, используя API Grafana:

```bash
GRAFANA_URL="https://your-grafana-instance"
API_KEY="your-api-key"

curl -sS -X POST "$GRAFANA_URL/api/dashboards/db" \
  -H "Authorization: Bearer $API_KEY" \
  -H "Content-Type: application/json" \
  --data-binary @10619_rev2.json
```

Замените `GRAFANA_URL` и `API_KEY` на URL вашего экземпляра Grafana и API-ключ.

## Переменные дашборда

Дашборд использует следующие переменные для фильтрации и настройки отображаемых данных:

* **`job`** — метка задачи для метрик cAdvisor (по умолчанию: `cadvisor`). Используется для выбора соответствующего источника метрик.
* **`node`** — имя хоста или узла. Поддерживает значение `All` через regex для одновременного отображения метрик со всех хостов.
* **`port`** — номер порта. Поддерживает значение `All` через regex для агрегации метрик по разным портам.
* **`interval`** — интервал запроса, который контролирует разрешение временных рядов данных на панелях.

Эти переменные можно настроить с помощью выпадающих списков в верхней части дашборда.

## Панели

Дашборд включает следующие панели, организованные для эффективного мониторинга:

* **Running containers (Запущенные контейнеры)** — отображает количество запущенных контейнеров на основе `max_over_time(container_last_seen[5m])`.
* **CPU usage on node (Использование CPU на узле)** — показывает общее использование CPU на Docker-хосте.
* **CPU usage per container (Использование CPU по контейнерам)** — детализирует использование CPU отдельными контейнерами.
* **Memory usage per container (Использование памяти по контейнерам)** — отображает потребление памяти каждым контейнером.
* **Memory cache per container (Кэш памяти по контейнерам)** — показывает использование кэша памяти контейнерами.
* **Free/used disk space per mount (Свободное/занятое дисковое пространство по точкам монтирования)** — визуализирует использование дискового пространства для каждой смонтированной файловой системы.
* **Disk I/O per device (Дисковый I/O по устройствам)** — отслеживает операции чтения/записи для устройств хранения.
* **Network traffic on node (Сетевой трафик на узле)** — показывает входящий/исходящий сетевой трафик для хоста.
* **Network traffic per container (Сетевой трафик по контейнерам)** — отображает использование сети с разбивкой по контейнерам.
* **Versions table (Таблица версий)** — перечисляет версии cAdvisor, Prometheus, node_exporter, Docker, ОС и ядра для быстрой справки.

Компоновка начинается с обобщённых метрик вверху, детализация использования ресурсов в средних рядах и системная информация внизу.

## Особенности имён метрик

Этот дашборд разработан для **node_exporter >= 0.16**, который использует суффиксы `_bytes` для метрик памяти и диска. Ключевые метрики, ожидаемые дашбордом:

* `node_memory_MemAvailable_bytes` — доступная память в байтах
* `node_memory_MemTotal_bytes` — общая память в байтах
* `node_disk_read_bytes_total` — всего байт прочитано с диска
* `node_disk_written_bytes_total` — всего байт записано на диск

Если вы используете более старую версию node_exporter с другими именами метрик, вам может потребоваться скорректировать PromQL-запросы в панелях дашборда в соответствии с вашей схемой именования метрик.

## Провижининг (опционально)

Для автоматического развёртывания можно использовать функцию провижининга Grafana для автоматической загрузки дашборда и источника данных.

### Провижининг дашбордов

Создайте файл провижининга по пути `/etc/grafana/provisioning/dashboards/docker.yaml`:

```yaml
apiVersion: 1
providers:
  - name: docker
    orgId: 1
    folder: Infrastructure
    type: file
    allowUiUpdates: true
    updateIntervalSeconds: 30
    options:
      path: /var/lib/grafana/dashboards
```

Разместите JSON-файл дашборда по адресу:
```
/var/lib/grafana/dashboards/docker-container-host-metrics.json
```

Настройте параметр `path` в соответствии с вашей конфигурацией Grafana.

### Провижининг источника данных

Создайте файл провижининга для источника данных Prometheus:

```yaml
apiVersion: 1
datasources:
  - name: Prometheus
    type: prometheus
    access: proxy
    url: http://prometheus:9090
    isDefault: true
    editable: true
```

Эта конфигурация предполагает, что Prometheus доступен по адресу `http://prometheus:9090`. Измените URL в соответствии с вашим экземпляром Prometheus.

## Диагностика

### Нет данных на панели "Running containers"

* Проверьте переменные дашборда: `job = cadvisor`, `node = All`, `port = All`.
* Убедитесь, что метрика `container_last_seen` существует в Prometheus за последние 5 минут.
* Выполните прямой запрос к Prometheus: `container_last_seen{job="cadvisor"}` для подтверждения наличия данных.

### Пустые панели памяти или диска

* Убедитесь, что node_exporter отдаёт метрики с суффиксами `_bytes`.
* Проверьте, что версия node_exporter >= 0.16.
* Проверьте, что имена метрик в Prometheus соответствуют ожидаемому формату.

### Общие проверки

* Посетите страницу целей Prometheus по адресу `http://prometheus:9090/targets`.
* Убедитесь, что цели задач `cadvisor` и `node` отображаются как **UP**.
* Проверьте, что источник данных Prometheus в Grafana настроен правильно и может выполнять запросы к Prometheus.
* Проверьте логи Grafana на наличие ошибок подключения к источнику данных.

## Разработка

Для внесения изменений или доработки дашборда:

1. Создайте ветку для новой функциональности:
   ```bash
   git checkout -b feat/grafana-docker-dashboard
   ```

2. Отредактируйте JSON-файл дашборда (`10619_rev2.json`) или внесите изменения непосредственно в Grafana и экспортируйте обновлённый JSON.

3. Зафиксируйте и отправьте изменения:
   ```bash
   git add 10619_rev2.json README.md README.ru.md
   git commit -m "Обновление дашборда: описание изменений"
   git push -u origin feat/grafana-docker-dashboard
   ```

Дашборд можно редактировать в UI Grafana, затем экспортировать обратно в репозиторий, чтобы хранить дашборд как код.

## Лицензия

Этот проект распространяется по лицензии **Unlicense** (эквивалент общественного достояния). Вы можете свободно использовать, изменять и распространять этот дашборд без каких-либо ограничений.

См. файл [LICENSE](LICENSE) для полной информации.
